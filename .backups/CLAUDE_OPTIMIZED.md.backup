# Bot Registro Obras Musicales - v2.6.0

## ğŸ¯ PropÃ³sito
AutomatizaciÃ³n del registro de obras musicales en AFIP/TAD Argentina.  
**Path**: `/Users/nahuelmaeso/Desktop/DemoJupiter/CLAUDE.BOTDNDA/registro-obras-bot`

## ğŸ”§ Stack
Node.js 18+ | TypeScript | Playwright | Zod | Winston | Jest | POM Pattern

## ğŸ“Š Estado Actual: PRODUCTION-READY (36/36 pasos)
| Fase | Pasos | Estado | DescripciÃ³n |
|------|-------|---------|-------------|
| Auth | 1-8 | âœ… | AFIP login + representado |
| Nav | 9-11 | âœ… | BÃºsqueda/inicio trÃ¡mite |
| Forms | 12-17 | âœ… | CarÃ¡tula + condiciones |
| Obra | 18-30 | âœ… | Datos completos + autores |
| Autores | 31 | âœ… | Multi-autor con form targeting |
| Editores | 32-35 | âœ… | Forms + datos + docs |
| Verify | 36 | âœ… | ValidaciÃ³n final |

## ğŸš€ Inicio RÃ¡pido
```bash
npm install                    # Instalar dependencias
npm start                      # Ejecutar bot
npm run explore               # Modo debug
npm run tools:find-selector   # Buscar selectores
```

## ğŸ¤– Protocolo LLM v2.0 (OBLIGATORIO)

### 1ï¸âƒ£ Carga de Contexto
```bash
cat package.json | grep version                              # v2.6.0
grep "export const TOTAL_STEPS" src/config/steps.config.ts  # 36 pasos
head -200 CHANGELOG.md | grep -A 20 "^##"                  # Cambios recientes
```

### 2ï¸âƒ£ Lectura Requerida
1. **Este archivo completo**
2. **CHANGELOG.md** (Ãºltimas 5 entradas)
3. **Documentos crÃ­ticos**:
   - `Protocolo de agregado de pasos.md`
   - `best_practices_for_this_project.md`
   - `Post Failure Analysis System.md`
   - `TECNICAS_SELECTORES_ROBUSTOS.md`

### 3ï¸âƒ£ Formato Changelog Obligatorio
```markdown
## [VERSION] - YYYY-MM-DD
### Type - Brief Title
#### Context
- **Current State**: Estado antes del cambio
- **Problem/Need**: Por quÃ© se necesita
#### Implementation
- **Approach**: Estrategia tÃ©cnica
- **Key Changes**: Modificaciones principales
#### Validation
- **Testing Method**: CÃ³mo se probÃ³
- **Success Metrics**: QuÃ© prueba que funciona
```

## ğŸ“ Estructura Clave
```
ğŸ“ registro-obras-bot/
â”œâ”€â”€ ğŸ“„ data/tramite_ejemplo.json    # Formato entrada
â”œâ”€â”€ ğŸ“ output/{runs,screenshots,logs}
â”œâ”€â”€ ğŸ“ src/
â”‚   â”œâ”€â”€ common/{browser,interaction,logger}*.ts
â”‚   â”œâ”€â”€ config/index.ts + steps.config.ts
â”‚   â”œâ”€â”€ core/{orchestrator,dataReader}.ts
â”‚   â”œâ”€â”€ services/{afipAuth,tadRegistration,obraForm}.service.ts
â”‚   â”œâ”€â”€ pages/*Page.ts (POM pattern)
â”‚   â””â”€â”€ types/{schema,tad.types}.ts
â””â”€â”€ ğŸ“„ .env (AFIP_CUIT, AFIP_PASSWORD)
```

## ğŸ¯ Patrones CrÃ­ticos (PRESERVAR)

### Multi-Strategy Selectors
```typescript
// âœ… SUCCESS_STRATEGY marca cÃ³digo optimizado - NUNCA cambiar orden
const strategies = [
  { name: 'By name', locator: page => page.locator('[name="field"]') },      // MÃ¡s estable ZK
  { name: 'By role', locator: page => page.getByRole('button') },           // SemÃ¡ntico
  { name: 'By text', locator: page => page.locator('text="Submit"') }       // Visual
];
```

### Performance Benchmarks
| Paso | OperaciÃ³n | Tiempo | Mejora | Nota |
|------|-----------|---------|--------|------|
| 9 | BÃºsqueda | <2s | 300% | `input[placeholder*="Buscar" i]` |
| 13 | Dropdown | <2s | 6400% | name + cell role combo |
| 16 | GUARDAR | <1s | 5000% | Enhanced button targeting |

### ZK Framework Patterns
```typescript
// âŒ MALO: IDs dinÃ¡micos
page.locator('#s5IQj')  // Cambia cada sesiÃ³n

// âœ… BUENO: Atributos estables
page.locator('[name="cmb_usted_opta"]')
page.locator('tr:has-text("Â¿Usted opta") button')
```

## ğŸ“‹ Estructura Datos JSON
```json
{
  "obra": {
    "titulo": "string",
    "tipo": "MÃºsica y letra|MÃºsica|Letra",
    "album": boolean,
    "cantidad_ejemplares": number,
    "genero_musical": "string",
    "esPublicacionWeb": boolean,
    "urlPaginaWeb": "required if web",
    "lugar_publicacion": "required if physical",
    "fecha_publicacion": "DD-MM-YYYY"
  },
  "autores": [{
    "nombre": { "primerNombre": "req", "segundoNombre": "opt" },
    "apellido": { "primerApellido": "req", "segundoApellido": "opt" },
    "fiscalId": { "tipo": "CUIT|CUIL|CDI|Extranjero", "numero": "XX-XXXXXXXX-X" },
    "nacionalidad": "string",
    "rol": "Letra|MÃºsica|MÃºsica y Letra"  // STRICT enum
  }],
  "editores": [{
    "tipoPersona": "Persona Juridica|Persona Fisica",
    "razonSocial": "if juridica",
    "nombre/apellido": "if fisica (like autores)",
    "porcentajeTitularidad": number  // any % allowed, no sum validation
  }],
  "gestor": {
    "representado": "exact match 90%+",
    "emailNotificaciones": "string"
  }
}
```

## ğŸ”¨ Protocolo Agregar Pasos v2.0

### Fase 1: AnÃ¡lisis Pre-ImplementaciÃ³n
1. **Detectar ZK**: Buscar clases `.z-*`
2. **Analizar DOM**: Identificar atributos estables
3. **Verificar mÃºltiples**: Probar "strict mode violations"

### Fase 2: ImplementaciÃ³n
```typescript
// 1. Definir en steps.config.ts
{ number: 37, name: 'nuevo_paso', service: 'tad', required: true }

// 2. Implementar con multi-strategy
const strategies = [
  { name: 'Primary: name attr', action: async () => {...} },
  { name: 'Fallback: context', action: async () => {...} }
];

// 3. VERIFICACIÃ“N OBLIGATORIA
const verified = await page.locator('input').isChecked();
if (!verified) throw new Error('Action failed');

// 4. Screenshot validaciÃ³n
await takeScreenshot('step-37-completed');
```

## ğŸš¨ Reglas CrÃ­ticas

### NUNCA:
- âŒ Remover `SUCCESS_STRATEGY`
- âŒ Cambiar orden de estrategias optimizadas
- âŒ Usar IDs dinÃ¡micos `#s5IQj`
- âŒ Commitear credenciales
- âŒ Saltar changelog

### SIEMPRE:
- âœ… Leer changelog reciente
- âœ… Preservar optimizaciones
- âœ… Multi-strategy para nuevas interacciones
- âœ… Screenshots antes/despuÃ©s
- âœ… Verificar estado real, no solo click

## ğŸ“ Comandos Debug
```bash
grep -r "SUCCESS_STRATEGY" src/          # Ver optimizaciones
grep -r "step.*19" src/                 # Buscar paso
tail -f output/logs/app-*.log | grep ERROR
npm run tools:audit                      # Verificar selectores
```

## ğŸ“ˆ Logros TÃ©cnicos
- **Step 34**: EliminaciÃ³n falsos positivos con verificaciÃ³n visual
- **Step 31**: Multi-autor con form targeting individual
- **Step 28-29**: PublicaciÃ³n web/fÃ­sica inteligente
- **Performance**: 64s â†’ 1s en operaciones crÃ­ticas
- **Production**: Validado con 4 editores mixtos

## ğŸ” Seguridad
- Credenciales en `.env` (nunca en git)
- Screenshots pueden contener info sensible
- Logs con rotaciÃ³n automÃ¡tica
- ValidaciÃ³n entrada con Zod

---
**v2.6.0** | 36 pasos completos | PRODUCTION-READY  
Documentos completos en `/docs/` | Ãšltima actualizaciÃ³n: 2025-01-14